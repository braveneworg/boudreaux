'use server';

import 'server-only';
import { setUnknownError } from '@/app/lib/utils/auth/auth-utils';
import getActionState from '@/app/lib/utils/auth/get-action-state';
import changeEmailSchema from '@/app/lib/validation/change-email-schema';
import { redirect } from 'next/navigation';
import { prisma } from '../prisma';
import { Prisma } from '@prisma/client';
import { CustomPrismaAdapter } from '@/app/lib/prisma-adapter';
import type { FormState } from '../types/form-state';

export
const changeEmailAction = async (_initialState: FormState, payload: FormData) => {
  const permittedFieldNames = [
    'email',
    'confirmEmail',
  ];

  const { formState, parsed } = getActionState(payload, permittedFieldNames, changeEmailSchema);

  if (parsed.success) {
    const adapter = CustomPrismaAdapter(prisma);

    try {
      const { email } = formState.fields!;
      formState.hasTimeout = false;

      const user = await adapter.getUserByEmail(email);