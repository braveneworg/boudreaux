name: Test SSH Connection

on:
  workflow_dispatch:

jobs:
  test-ssh:
    name: Test SSH to EC2
    runs-on: ubuntu-latest
    steps:
      - name: Check GitHub Runner IP
        run: |
          echo "GitHub Runner IP:"
          curl -s https://api.ipify.org
          echo ""

      - name: Test SSH connection with timeout
        run: |
          echo '${{secrets.SSH_PRIVATE_KEY}}' > /tmp/temp_key
          chmod 600 /tmp/temp_key

          echo "Testing SSH connection to EC2..."
          echo "Host: ${{secrets.EC2_USERNAME}}@${{ secrets.EC2_HOST }}"

          # Test with verbose output and shorter timeout
          ssh -i /tmp/temp_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -o ConnectionAttempts=3 \
            -vvv \
            ${{secrets.EC2_USERNAME}}@${{ secrets.EC2_HOST }} \
            "echo 'SSH connection successful!'; uptime" 2>&1 || echo "SSH failed with exit code $?"

          rm /tmp/temp_key
